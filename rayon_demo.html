<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>BattleO - Rayon WASM Demo</title>
    <style>
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
        background-color: #f5f5f5;
        line-height: 1.6;
      }
      .container {
        background: white;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
      }
      h1 {
        color: #333;
        text-align: center;
        margin-bottom: 30px;
        font-size: 2.5em;
      }
      h2 {
        color: #555;
        border-bottom: 2px solid #007bff;
        padding-bottom: 10px;
        margin-top: 30px;
      }
      .demo-section {
        margin: 20px 0;
        padding: 20px;
        border: 1px solid #ddd;
        border-radius: 5px;
        background-color: #fafafa;
      }
      .demo-section h3 {
        color: #555;
        margin-top: 0;
      }
      button {
        background-color: #007bff;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 5px;
        cursor: pointer;
        margin: 5px;
        font-size: 14px;
        transition: background-color 0.3s;
      }
      button:hover {
        background-color: #0056b3;
      }
      button:disabled {
        background-color: #6c757d;
        cursor: not-allowed;
      }
      .output {
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 5px;
        padding: 15px;
        margin: 10px 0;
        font-family: "Courier New", monospace;
        white-space: pre-wrap;
        max-height: 300px;
        overflow-y: auto;
        font-size: 12px;
      }
      .status {
        padding: 10px;
        border-radius: 5px;
        margin: 10px 0;
      }
      .status.success {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }
      .status.error {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }
      .status.info {
        background-color: #d1ecf1;
        color: #0c5460;
        border: 1px solid #bee5eb;
      }
      .performance-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin: 20px 0;
      }
      .performance-card {
        background: white;
        padding: 20px;
        border-radius: 8px;
        border: 1px solid #ddd;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      .performance-card h4 {
        margin-top: 0;
        color: #333;
        border-bottom: 1px solid #eee;
        padding-bottom: 10px;
      }
      .metric {
        display: flex;
        justify-content: space-between;
        margin: 8px 0;
        padding: 5px 0;
        border-bottom: 1px solid #f0f0f0;
      }
      .metric-label {
        font-weight: 500;
        color: #555;
      }
      .metric-value {
        font-weight: bold;
        color: #007bff;
      }
      .simulation-container {
        display: grid;
        grid-template-columns: 1fr 300px;
        gap: 20px;
        margin: 20px 0;
      }
      .canvas-container {
        background: #000;
        border-radius: 8px;
        overflow: hidden;
        position: relative;
      }
      #simulation-canvas {
        display: block;
        width: 100%;
        height: 600px;
      }
      .controls {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        border: 1px solid #dee2e6;
      }
      .control-group {
        margin-bottom: 20px;
      }
      .control-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: 500;
        color: #555;
      }
      .control-group input[type="range"] {
        width: 100%;
        margin: 5px 0;
      }
      .control-group input[type="number"] {
        width: 60px;
        padding: 5px;
        border: 1px solid #ddd;
        border-radius: 3px;
      }
      .feature-detection {
        background: #e7f3ff;
        border: 1px solid #b3d9ff;
        border-radius: 5px;
        padding: 15px;
        margin: 20px 0;
      }
      .feature-detection h4 {
        margin-top: 0;
        color: #0066cc;
      }
      .feature-item {
        display: flex;
        justify-content: space-between;
        margin: 8px 0;
        padding: 5px 0;
      }
      .feature-supported {
        color: #28a745;
        font-weight: bold;
      }
      .feature-unsupported {
        color: #dc3545;
        font-weight: bold;
      }
      .loading {
        text-align: center;
        padding: 40px;
        color: #666;
      }
      .spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #007bff;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto 20px;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
      .tabs {
        display: flex;
        border-bottom: 1px solid #ddd;
        margin-bottom: 20px;
      }
      .tab {
        padding: 10px 20px;
        cursor: pointer;
        border: 1px solid transparent;
        border-bottom: none;
        background: #f8f9fa;
        margin-right: 5px;
        border-radius: 5px 5px 0 0;
      }
      .tab.active {
        background: white;
        border-color: #ddd;
        margin-bottom: -1px;
      }
      .tab-content {
        display: none;
      }
      .tab-content.active {
        display: block;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üöÄ BattleO - Rayon WASM Demo</h1>
      <p style="text-align: center; color: #666; font-size: 1.1em">
        Demonstrating parallel processing in WebAssembly using Rayon and
        wasm-bindgen-rayon
      </p>
    </div>

    <div class="container">
      <div class="feature-detection">
        <h4>üîç Browser Feature Detection</h4>
        <div id="feature-detection-results">
          <div class="loading">
            <div class="spinner"></div>
            Detecting browser capabilities...
          </div>
        </div>
      </div>
    </div>

    <div class="container">
      <div class="tabs">
        <div class="tab active" onclick="switchTab('parallel')">
          Parallel Processing
        </div>
        <div class="tab" onclick="switchTab('simulation')">
          Battle Simulation
        </div>
        <div class="tab" onclick="switchTab('performance')">
          Performance Tests
        </div>
      </div>

      <div id="parallel-tab" class="tab-content active">
        <h2>üßµ Parallel Processing Demo</h2>
        <div class="demo-section">
          <h3>Thread Pool Initialization</h3>
          <p>
            Initialize the Rayon thread pool for parallel processing in
            WebAssembly.
          </p>
          <button id="init-pool-btn" onclick="initializeThreadPool()">
            Initialize Thread Pool
          </button>
          <div id="init-status" class="status info" style="display: none"></div>
        </div>

        <div class="demo-section">
          <h3>Parallel Operations</h3>
          <p>Test various parallel operations with different data sizes.</p>
          <div class="performance-grid">
            <div class="performance-card">
              <h4>Parallel Sum</h4>
              <div class="metric">
                <span class="metric-label">Data Size:</span>
                <input
                  type="number"
                  id="sum-size"
                  value="1000000"
                  min="1000"
                  max="10000000"
                />
              </div>
              <button onclick="testParallelSum()">Test Parallel Sum</button>
              <div id="sum-result" class="output" style="display: none"></div>
            </div>

            <div class="performance-card">
              <h4>Parallel Map</h4>
              <div class="metric">
                <span class="metric-label">Data Size:</span>
                <input
                  type="number"
                  id="map-size"
                  value="1000000"
                  min="1000"
                  max="10000000"
                />
              </div>
              <button onclick="testParallelMap()">Test Parallel Map</button>
              <div id="map-result" class="output" style="display: none"></div>
            </div>

            <div class="performance-card">
              <h4>Complex Operation</h4>
              <div class="metric">
                <span class="metric-label">Data Size:</span>
                <input
                  type="number"
                  id="complex-size"
                  value="1000000"
                  min="1000"
                  max="10000000"
                />
              </div>
              <button onclick="testComplexOperation()">
                Test Complex Operation
              </button>
              <div
                id="complex-result"
                class="output"
                style="display: none"
              ></div>
            </div>
          </div>
        </div>
      </div>

      <div id="simulation-tab" class="tab-content">
        <h2>‚öîÔ∏è Battle Simulation</h2>
        <div class="simulation-container">
          <div class="canvas-container">
            <canvas id="simulation-canvas"></canvas>
          </div>
          <div class="controls">
            <div class="control-group">
              <label>Simulation Controls</label>
              <button id="start-btn" onclick="startSimulation()">Start</button>
              <button id="stop-btn" onclick="stopSimulation()" disabled>
                Stop
              </button>
              <button onclick="resetSimulation()">Reset</button>
            </div>

            <div class="control-group">
              <label>Add Agents</label>
              <button onclick="addAgent()">Add Agent</button>
              <button onclick="addResource()">Add Resource</button>
            </div>

            <div class="control-group">
              <label>Rendering</label>
              <button onclick="toggleRendering()">Toggle WebGL/Canvas</button>
              <div id="rendering-mode" class="metric">
                <span class="metric-label">Mode:</span>
                <span class="metric-value">Canvas 2D</span>
              </div>
            </div>

            <div class="control-group">
              <label>Statistics</label>
              <div
                id="stats"
                class="output"
                style="max-height: 200px; font-size: 11px"
              ></div>
            </div>
          </div>
        </div>
      </div>

      <div id="performance-tab" class="tab-content">
        <h2>üìä Performance Benchmarking</h2>
        <div class="demo-section">
          <h3>Comprehensive Performance Test</h3>
          <p>
            Run a series of performance tests to compare sequential vs parallel
            processing.
          </p>
          <button onclick="runPerformanceBenchmark()">Run Benchmark</button>
          <div
            id="benchmark-results"
            class="output"
            style="display: none"
          ></div>
        </div>

        <div class="demo-section">
          <h3>Scalability Test</h3>
          <p>
            Test how performance scales with different data sizes and thread
            counts.
          </p>
          <button onclick="runScalabilityTest()">Run Scalability Test</button>
          <div
            id="scalability-results"
            class="output"
            style="display: none"
          ></div>
        </div>
      </div>
    </div>

    <script type="module">
      import init, {
        ParallelProcessor,
        BattleSimulation,
        init_rayon_pool,
      } from "./pkg/battleo.js";

      let wasmModule = null;
      let parallelProcessor = null;
      let battleSimulation = null;
      let isInitialized = false;

      // Feature detection
      async function detectFeatures() {
        const results = document.getElementById("feature-detection-results");
        results.innerHTML = "";

        const features = [
          {
            name: "WebAssembly",
            test: () => typeof WebAssembly !== "undefined",
          },
          {
            name: "SharedArrayBuffer",
            test: () => typeof SharedArrayBuffer !== "undefined",
          },
          { name: "Web Workers", test: () => typeof Worker !== "undefined" },
          {
            name: "WebGL",
            test: () => {
              const canvas = document.createElement("canvas");
              return !!(
                canvas.getContext("webgl") ||
                canvas.getContext("experimental-webgl")
              );
            },
          },
          {
            name: "WebGL2",
            test: () => {
              const canvas = document.createElement("canvas");
              return !!canvas.getContext("webgl2");
            },
          },
          {
            name: "Cross-Origin Isolation",
            test: () => {
              return crossOriginIsolated;
            },
          },
        ];

        features.forEach((feature) => {
          const item = document.createElement("div");
          item.className = "feature-item";

          const name = document.createElement("span");
          name.textContent = feature.name;

          const status = document.createElement("span");
          const isSupported = feature.test();
          status.textContent = isSupported
            ? "‚úÖ Supported"
            : "‚ùå Not Supported";
          status.className = isSupported
            ? "feature-supported"
            : "feature-unsupported";

          item.appendChild(name);
          item.appendChild(status);
          results.appendChild(item);
        });
      }

      // Initialize WASM module
      async function initializeWasm() {
        try {
          console.log("Initializing WASM module...");
          wasmModule = await init();
          console.log("WASM module initialized successfully");

          // Create parallel processor
          parallelProcessor = new ParallelProcessor();
          console.log("Parallel processor created");

          // Create battle simulation
          battleSimulation = new BattleSimulation("simulation-canvas");
          console.log("Battle simulation created");

          isInitialized = true;
          console.log("All components initialized");

          // Update UI
          document.getElementById("init-pool-btn").disabled = false;
          document.getElementById("start-btn").disabled = false;
        } catch (error) {
          console.error("Failed to initialize WASM:", error);
          showStatus("Failed to initialize WASM module", "error");
        }
      }

      // Initialize thread pool
      window.initializeThreadPool = async function () {
        if (!isInitialized) {
          showStatus("WASM module not initialized", "error");
          return;
        }

        const statusDiv = document.getElementById("init-status");
        statusDiv.style.display = "block";
        statusDiv.className = "status info";
        statusDiv.textContent = "Initializing thread pool...";

        try {
          await parallelProcessor.initialize();

          statusDiv.className = "status success";
          statusDiv.textContent = `Thread pool initialized with ${parallelProcessor.get_worker_count()} workers`;

          console.log("Thread pool initialized successfully");
        } catch (error) {
          console.error("Thread pool initialization failed:", error);
          
          // Check if it's a SharedArrayBuffer error
          if (error.message.includes('SharedArrayBuffer') || error.message.includes('crossOriginIsolated')) {
            statusDiv.className = "status error";
            statusDiv.innerHTML = `
              <strong>SharedArrayBuffer Error:</strong><br>
              This browser/environment doesn't support SharedArrayBuffer for threading.<br>
              <button onclick="initializeFallback()" style="margin-top: 10px; padding: 5px 10px;">
                Use Fallback Mode
              </button>
            `;
            showStatus('SharedArrayBuffer not available - try fallback mode', 'error');
          } else {
            statusDiv.className = "status error";
            statusDiv.textContent = "Failed to initialize thread pool: " + error.message;
          }
        }
      };

      // Fallback initialization
      window.initializeFallback = async function() {
        if (!isInitialized) {
          showStatus("WASM module not initialized", "error");
          return;
        }

        const statusDiv = document.getElementById("init-status");
        statusDiv.style.display = "block";
        statusDiv.className = "status info";
        statusDiv.textContent = "Initializing fallback mode...";

        try {
          await parallelProcessor.initialize_fallback();
          
          statusDiv.className = "status success";
          statusDiv.textContent = "Fallback mode initialized (sequential processing)";
          
          console.log("Fallback mode initialized successfully");
          showStatus("Using fallback mode - parallel operations will use sequential processing", "info");
        } catch (error) {
          statusDiv.className = "status error";
          statusDiv.textContent = "Failed to initialize fallback mode: " + error.message;
          console.error("Fallback initialization failed:", error);
        }
      };

      // Test parallel sum
      window.testParallelSum = async function () {
        if (!isInitialized) {
          showStatus("WASM module not initialized", "error");
          return;
        }

        const size = parseInt(document.getElementById("sum-size").value);
        const resultDiv = document.getElementById("sum-result");

        resultDiv.style.display = "block";
        resultDiv.textContent = "Generating test data...";

        try {
          // Generate test data
          const data = Array.from({ length: size }, (_, i) => Math.random());

          resultDiv.textContent = "Running parallel sum...";

          const start = performance.now();
          const result = parallelProcessor.parallel_sum(data);
          const end = performance.now();

          const duration = end - start;
          const expectedSum = data.reduce((a, b) => a + b, 0);
          const error = Math.abs(result - expectedSum);

          resultDiv.textContent = `Parallel Sum Results:
Data Size: ${size.toLocaleString()}
Result: ${result.toFixed(6)}
Expected: ${expectedSum.toFixed(6)}
Error: ${error.toFixed(10)}
Duration: ${duration.toFixed(2)}ms
Speed: ${((size / duration) * 1000).toLocaleString()} ops/sec`;
        } catch (error) {
          resultDiv.textContent = "Error: " + error.message;
          console.error("Parallel sum test failed:", error);
        }
      };

      // Test parallel map
      window.testParallelMap = async function () {
        if (!isInitialized) {
          showStatus("WASM module not initialized", "error");
          return;
        }

        const size = parseInt(document.getElementById("map-size").value);
        const resultDiv = document.getElementById("map-result");

        resultDiv.style.display = "block";
        resultDiv.textContent = "Generating test data...";

        try {
          const data = Array.from({ length: size }, (_, i) => Math.random());

          resultDiv.textContent = "Running parallel map...";

          const start = performance.now();
          const result = parallelProcessor.parallel_map(data);
          const end = performance.now();

          const duration = end - start;
          const expectedResult = data.map((x) => x * 2.0);
          const firstFew = result.slice(0, 5);
          const expectedFirstFew = expectedResult.slice(0, 5);

          resultDiv.textContent = `Parallel Map Results:
Data Size: ${size.toLocaleString()}
Duration: ${duration.toFixed(2)}ms
Speed: ${((size / duration) * 1000).toLocaleString()} ops/sec
First 5 results: [${firstFew.map((x) => x.toFixed(3)).join(", ")}]
Expected: [${expectedFirstFew.map((x) => x.toFixed(3)).join(", ")}]`;
        } catch (error) {
          resultDiv.textContent = "Error: " + error.message;
          console.error("Parallel map test failed:", error);
        }
      };

      // Test complex operation
      window.testComplexOperation = async function () {
        if (!isInitialized) {
          showStatus("WASM module not initialized", "error");
          return;
        }

        const size = parseInt(document.getElementById("complex-size").value);
        const resultDiv = document.getElementById("complex-result");

        resultDiv.style.display = "block";
        resultDiv.textContent = "Generating test data...";

        try {
          const data = Array.from({ length: size }, (_, i) => Math.random());

          resultDiv.textContent = "Running complex operation...";

          const start = performance.now();
          const result = parallelProcessor.complex_parallel_operation(data);
          const end = performance.now();

          const duration = end - start;
          const expectedResult = Math.sqrt(
            data.reduce((sum, x) => sum + x * x, 0)
          );
          const error = Math.abs(result - expectedResult);

          resultDiv.textContent = `Complex Operation Results:
Data Size: ${size.toLocaleString()}
Result: ${result.toFixed(6)}
Expected: ${expectedResult.toFixed(6)}
Error: ${error.toFixed(10)}
Duration: ${duration.toFixed(2)}ms
Speed: ${((size / duration) * 1000).toLocaleString()} ops/sec`;
        } catch (error) {
          resultDiv.textContent = "Error: " + error.message;
          console.error("Complex operation test failed:", error);
        }
      };

      // Simulation controls
      window.startSimulation = function () {
        if (battleSimulation) {
          battleSimulation.start();
          document.getElementById("start-btn").disabled = true;
          document.getElementById("stop-btn").disabled = false;
          updateStats();
        }
      };

      window.stopSimulation = function () {
        if (battleSimulation) {
          battleSimulation.stop();
          document.getElementById("start-btn").disabled = false;
          document.getElementById("stop-btn").disabled = true;
        }
      };

      window.resetSimulation = function () {
        if (battleSimulation) {
          battleSimulation.reset();
          updateStats();
        }
      };

      window.addAgent = function () {
        if (battleSimulation) {
          const x = Math.random() * 800;
          const y = Math.random() * 600;
          battleSimulation.add_agent(x, y);
        }
      };

      window.addResource = function () {
        if (battleSimulation) {
          const x = Math.random() * 800;
          const y = Math.random() * 600;
          battleSimulation.add_resource(x, y);
        }
      };

      window.toggleRendering = function () {
        if (battleSimulation) {
          const mode = battleSimulation.get_rendering_mode();
          const modeSpan = document.querySelector(
            "#rendering-mode .metric-value"
          );
          modeSpan.textContent = mode;
        }
      };

      function updateStats() {
        if (battleSimulation) {
          const stats = battleSimulation.get_stats();
          const statsDiv = document.getElementById("stats");
          statsDiv.textContent = JSON.stringify(stats, null, 2);
        }
      }

      // Performance benchmarking
      window.runPerformanceBenchmark = async function () {
        if (!isInitialized) {
          showStatus("WASM module not initialized", "error");
          return;
        }

        const resultDiv = document.getElementById("benchmark-results");
        resultDiv.style.display = "block";
        resultDiv.textContent = "Running performance benchmark...";

        try {
          const sizes = [10000, 100000, 1000000];
          const results = [];

          for (const size of sizes) {
            const data = Array.from({ length: size }, (_, i) => Math.random());

            // Test sequential (JavaScript)
            const seqStart = performance.now();
            const seqResult = data.reduce((a, b) => a + b, 0);
            const seqEnd = performance.now();
            const seqDuration = seqEnd - seqStart;

            // Test parallel (WASM)
            const parStart = performance.now();
            const parResult = parallelProcessor.parallel_sum(data);
            const parEnd = performance.now();
            const parDuration = parEnd - parStart;

            results.push({
              size,
              sequential: seqDuration,
              parallel: parDuration,
              speedup: seqDuration / parDuration,
              error: Math.abs(seqResult - parResult),
            });
          }

          let report = "Performance Benchmark Results:\n\n";
          results.forEach((r) => {
            report += `Data Size: ${r.size.toLocaleString()}\n`;
            report += `Sequential: ${r.sequential.toFixed(2)}ms\n`;
            report += `Parallel: ${r.parallel.toFixed(2)}ms\n`;
            report += `Speedup: ${r.speedup.toFixed(2)}x\n`;
            report += `Error: ${r.error.toFixed(10)}\n\n`;
          });

          resultDiv.textContent = report;
        } catch (error) {
          resultDiv.textContent = "Error: " + error.message;
          console.error("Performance benchmark failed:", error);
        }
      };

      window.runScalabilityTest = async function () {
        if (!isInitialized) {
          showStatus("WASM module not initialized", "error");
          return;
        }

        const resultDiv = document.getElementById("scalability-results");
        resultDiv.style.display = "block";
        resultDiv.textContent = "Running scalability test...";

        try {
          const baseSize = 100000;
          const multipliers = [1, 2, 4, 8, 16];
          const results = [];

          for (const mult of multipliers) {
            const size = baseSize * mult;
            const data = Array.from({ length: size }, (_, i) => Math.random());

            const start = performance.now();
            const result = parallelProcessor.parallel_sum(data);
            const end = performance.now();
            const duration = end - start;

            results.push({
              size,
              duration,
              throughput: (size / duration) * 1000,
            });
          }

          let report = "Scalability Test Results:\n\n";
          results.forEach((r) => {
            report += `Data Size: ${r.size.toLocaleString()}\n`;
            report += `Duration: ${r.duration.toFixed(2)}ms\n`;
            report += `Throughput: ${r.throughput.toLocaleString()} ops/sec\n\n`;
          });

          resultDiv.textContent = report;
        } catch (error) {
          resultDiv.textContent = "Error: " + error.message;
          console.error("Scalability test failed:", error);
        }
      };

      // Tab switching
      window.switchTab = function (tabName) {
        // Hide all tabs
        document.querySelectorAll(".tab-content").forEach((tab) => {
          tab.classList.remove("active");
        });
        document.querySelectorAll(".tab").forEach((tab) => {
          tab.classList.remove("active");
        });

        // Show selected tab
        document.getElementById(tabName + "-tab").classList.add("active");
        event.target.classList.add("active");
      };

      function showStatus(message, type) {
        const statusDiv = document.createElement("div");
        statusDiv.className = `status ${type}`;
        statusDiv.textContent = message;
        document.body.insertBefore(statusDiv, document.body.firstChild);

        setTimeout(() => {
          statusDiv.remove();
        }, 5000);
      }

      // Initialize everything
      async function main() {
        try {
          await detectFeatures();
          await initializeWasm();
          showStatus("WASM module loaded successfully!", "success");
        } catch (error) {
          console.error("Initialization failed:", error);
          showStatus("Failed to initialize: " + error.message, "error");
        }
      }

      main();
    </script>
  </body>
</html>
